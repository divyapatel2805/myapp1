name: Deploy Service - TEST1
on: 
   workflow_dispatch:

jobs:
  ReadJSON:
    name: "Reading JSON Object"
    runs-on: ubuntu-latest
    outputs:
      service-deployment-ring: ${{ steps.export-service-deployment-matrix.outputs.service-deployment-ring }}
      service-deployment-regions: ${{ steps.export-service-deployment-matrix.outputs.service-deployment-regions }}
      service-deployment-locations: ${{ steps.export-service-deployment-matrix.outputs.service-deployment-locations }}
      service-deployment-envTypes: ${{ steps.export-service-deployment-matrix.outputs.service-deployment-envTypes }}
      service-deployment-env: ${{ steps.export-service-deployment-matrix.outputs.service-deployment-env }}
    steps:
    - uses: actions/checkout@v2

    - name: Export deployment matrix
      id: export-service-deployment-matrix
      run: |
        
        Env="$(cat ./deployment-config.json | jq '.[]' | jq '.regions[]' | jq '.locations[]' | jq '.envTypes[]' | jq '.envs[]' | jq -s '.' )"
        Env="${Env//'%'/'%25'}"
        Env="${Env//$'\n'/'%0A'}"
        Env="${Env//$'\r'/'%0D'}"

        echo "::set-output name=service-deployment-env::$Env"

        echo "Env: $Env"

  Env:
    name: "${{ matrix.env.Ring }}-${{ matrix.env.Region }}-${{ matrix.env.Location }}-${{ matrix.env.EnvType }}-${{ matrix.env.displayName }}"
    runs-on: ubuntu-latest
    needs: [ReadJSON]
    strategy:
      matrix:
        env: ${{ fromJSON(needs.ReadJSON.outputs.service-deployment-env) }}
    steps:
    - run: |
            echo "displayName: ${{ matrix.env.displayName }}"
            echo "approvalStageEnv: ${{ matrix.env.approvalStageEnv }}"
            echo "environmentResourceGroup: ${{ matrix.env.environmentResourceGroup }}"
            echo "environment: ${{ matrix.env.environment }}"
            echo "environmentCode: ${{ matrix.env.environmentCode }}"
      

    
 
